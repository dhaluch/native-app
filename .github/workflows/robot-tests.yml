name: Run Robot Framework Tests

on:
  push:
    branches:
      - main
      - feature/*
  pull_request:
    branches:
      - main

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install robotframework

      - name: Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: Create Android emulator
        run: |
          echo "y" | sdkmanager --install 'system-images;android-30;google_apis;x86_64'
          echo "no" | avdmanager create avd -n test -k 'system-images;android-30;google_apis;x86_64' --device 'pixel'

      - name: Start Android emulator
        run: |
            nohup $ANDROID_HOME/emulator/emulator -avd test -no-audio -no-window &
            adb wait-for-device
            adb shell input keyevent 82

      - name: Wait for emulator to boot
        run: |
          boot_completed=false
          until $boot_completed; do
            boot_completed=$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')
            if [ "$boot_completed" = "1" ]; then
              break
            fi
            sleep 5
          done

      - name: Install Appium
        run: |
          npm install -g appium
          appium -v

      - name: Install Appium UIAutomator2 Driver
        run: |
          appium driver install uiautomator2@4.0.1

      - name: Start Appium server
        run: |
          nohup appium &

      - name: Install Robot Framework Appium Library
        run: |
          pip install robotframework-appiumlibrary

      - name: Run Robot Framework tests with report
        run: |
          robot --outputdir reports tests/

      - name: Upload Robot Framework report
        uses: actions/upload-artifact@v4
        with:
          name: robot-report
          path: reports/