name: Android Robot Tests

on:
  push:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest

    outputs:
      artifact_name: ${{ steps.set_meta.outputs.artifact_name }}
      date: ${{ steps.set_meta.outputs.date }}
      datetime: ${{ steps.set_meta.outputs.datetime }}
      branch: ${{ steps.set_meta.outputs.branch }}

    steps:
      - name: üì• Checkout code
        uses: actions/checkout@v4

      - name: üêç Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: üì¶ Install dependencies (Python)
        run: |
          python -m pip install --upgrade pip
          pip install robotframework
          pip install robotframework-appiumlibrary
          # Se seus testes N√ÉO usam Browser/Playwright, remova as 2 linhas abaixo:
          pip install robotframework-browser
          rfbrowser init

      - name: üü¢ Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ü§ñ Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: üõ†Ô∏è Configure PATH and Android folders
        run: |
          export PATH=$PATH:$ANDROID_HOME/emulator
          mkdir -p $HOME/.android
          touch $HOME/.android/emu-update-last-check.ini
          mkdir -p $HOME/.android/avd

      - name: üì≤ Create Android emulator (API 29 - default x86_64)
        run: |
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          export ANDROID_AVD_HOME=$HOME/.android/avd
          export PATH=$PATH:$ANDROID_HOME/emulator

          echo "y" | sdkmanager --install 'system-images;android-29;default;x86_64'

          echo "no" | avdmanager create avd \
            -n test \
            -k 'system-images;android-29;default;x86_64' \
            --device 'pixel' --force

          $ANDROID_HOME/emulator/emulator -list-avds || echo "‚ö†Ô∏è Nenhum AVD listado!"
          ls -la "$ANDROID_AVD_HOME" || echo "‚ö†Ô∏è Diret√≥rio AVD n√£o encontrado!"

      - name: üöÄ Start Android emulator (software mode)
        run: |
          export PATH=$PATH:$ANDROID_HOME/emulator
          nohup $ANDROID_HOME/emulator/emulator -avd test \
            -accel off \
            -gpu swiftshader_indirect \
            -no-boot-anim \
            -no-snapshot \
            -no-snapshot-save \
            -camera-back none \
            -camera-front none \
            -no-window \
            -no-audio &
          adb wait-for-device
          adb devices

      - name: ‚è≥ Wait for full boot (multi-signal, with timeouts)
        run: |
          set -e
          BOOT_TIMEOUT=420
          PM_TIMEOUT=240

          echo "‚è≥ Esperando sys.boot_completed ou dev.bootcomplete..."
          if ! timeout ${BOOT_TIMEOUT}s bash -c 'until adb shell getprop sys.boot_completed 2>/dev/null | tr -d "\r" | grep -q "^1$"; do sleep 3; done'; then
            echo "‚ö†Ô∏è sys.boot_completed n√£o sinalizou; usando dev.bootcomplete..."
            timeout ${BOOT_TIMEOUT}s bash -c 'until adb shell getprop dev.bootcomplete 2>/dev/null | tr -d "\r" | grep -q "^1$"; do sleep 3; done'
          fi
          echo "‚úÖ Sinal de boot recebido."

          echo "‚è≥ Checando boot animation (tolerante)..."
          timeout 180s bash -c 'until [ "$(adb shell getprop init.svc.bootanim 2>/dev/null | tr -d "\r")" = "stopped" ]; do sleep 2; done' || echo "‚ö†Ô∏è bootanim indispon√≠vel ‚Äî seguindo."

          echo "‚è≥ Esperando Package Manager (primeiro sinal)..."
          timeout ${PM_TIMEOUT}s bash -c 'until adb shell pm list packages >/dev/null 2>&1; do sleep 3; done'
          echo "‚úÖ Package Manager respondeu uma vez."

      - name: üîì Keep screen awake & go Home (no-fail)
        run: |
          adb shell settings put global stay_on_while_plugged_in 3 || true
          adb shell wm dismiss-keyguard || true
          adb shell am start -a android.intent.action.MAIN -c android.intent.category.HOME || true

      - name: ‚úÖ Ensure Android user & settings service ready + provision
        run: |
          set -e
          adb shell am start-user 0 || true

          SETTINGS_TIMEOUT=240
          echo "‚è≥ Aguardando servi√ßo 'settings'..."
          if ! timeout ${SETTINGS_TIMEOUT}s bash -c 'until adb shell cmd settings list global >/dev/null 2>&1; do sleep 3; done'; then
            echo "‚ùå Servi√ßo 'settings' n√£o respondeu dentro do timeout."
            adb shell service list | tail -n +1 || true
            exit 1
          fi
          echo "‚úÖ Servi√ßo 'settings' dispon√≠vel."

          adb shell cmd settings put global device_provisioned 1 || true
          adb shell cmd settings put secure user_setup_complete 1 || true
          sleep 5

      - name: ‚úÖ Final device readiness (service:package stable)
        run: |
          set -e
          adb shell am start-user 0 || true
          adb shell am start -a android.intent.action.MAIN -c android.intent.category.HOME || true

          echo "‚è≥ Aguardando service manager registrar 'package'..."
          timeout 300s bash -c 'until adb shell service check package 2>/dev/null | grep -q "found"; do echo "‚Ä¶ esperando service package"; sleep 3; done'
          echo "‚úÖ service: package dispon√≠vel."

          echo "‚è≥ Verificando 'pm list packages' 3x seguidas (estabiliza√ß√£o)..."
          ok=0
          for i in $(seq 1 30); do
            if adb shell pm list packages >/dev/null 2>&1; then
              ok=$((ok+1)); echo "‚úî PM ok ($ok/3)"
            else
              ok=0; echo "‚úñ PM falhou ‚Äî reset contador"
            fi
            [ $ok -ge 3 ] && break
            sleep 2
          done
          [ $ok -ge 3 ] || { echo "‚ùå Package Manager n√£o estabilizou."; adb shell service list | tail -n +1 || true; exit 1; }

      - name: üì¶ Pre-install AUT (apk) with retries
        run: |
          set -e
          APK_PATH="app/wdio.native.app.apk"  # ajuste o caminho se necess√°rio
          test -f "$APK_PATH" || { echo "‚ùå APK n√£o encontrado em $APK_PATH"; exit 1; }

          echo "‚è≥ Instalando APK via adb (at√© 5 tentativas)..."
          tries=0
          until adb install -r -g "$APK_PATH"; do
            tries=$((tries+1))
            echo "‚úñ Falha ao instalar (tentativa $tries)."
            if [ $tries -ge 5 ]; then
              echo "‚ùå N√£o foi poss√≠vel instalar o APK ap√≥s $tries tentativas."
              exit 1
            fi
            echo "‚è≥ Aguardando 10s e tentando novamente..."
            sleep 10
          done
          echo "‚úÖ APK instalado com sucesso."
          echo "‚è≥ Pr√©-lan√ßando app via ADB para acelerar startup (tentativa)..."
          adb shell am start -n com.wdiodemoapp/.MainActivity || true
          echo "‚è≥ Aguardando 20s ap√≥s pr√©-lan√ßamento do app"
          sleep 20

      - name: üì¶ Install Appium (CLI + driver)
        run: |
          npm install -g appium
          appium -v
          appium driver install uiautomator2@4.0.1

      - name: üèÉ Start Appium server
        run: |
          nohup appium > appium.log 2>&1 &
          echo "‚è≥ Aguardando 15s para Appium inicializar"
          sleep 15

      - name: üß≠ Set meta (date, branch, artifact name)
        id: set_meta
        run: |
            DATE=$(date +'%Y-%m-%d')
            DATETIME=$(date +'%Y-%m-%d %H:%M:%S')
            BRANCH='${{ github.ref_name }}'
            SAFE_BRANCH=$(echo "$BRANCH" | sed 's#[/\\:*?"<>|]#-#g')
            ARTIFACT_NAME="robot-logs-${SAFE_BRANCH}-${DATE}"
            echo "date=${DATE}" >> $GITHUB_OUTPUT
            echo "datetime=${DATETIME}" >> $GITHUB_OUTPUT
            echo "branch=${BRANCH}" >> $GITHUB_OUTPUT
            echo "artifact_name=${ARTIFACT_NAME}" >> $GITHUB_OUTPUT
            echo "Artifact: ${ARTIFACT_NAME}"

      - name: üß™ Run Robot Framework tests
        run: |
          mkdir -p logs
          robot --outputdir logs tests/

      - name: üß∑ Ensure logs folder (even on failure)
        if: always()
        env:
          BRANCH: ${{ steps.set_meta.outputs.branch }}
          DATE: ${{ steps.set_meta.outputs.date }}
        run: |
          mkdir -p logs
          [ -f logs/report.html ] || cat > logs/report.html <<HTML
          <!doctype html><meta charset="utf-8"><title>Robot Report ‚Äî ${BRANCH} ‚Äî ${DATE}</title>
          <h1>Robot Report ‚Äî ${BRANCH} ‚Äî ${DATE}</h1>
          <p>Nenhum relat√≥rio foi gerado. Verifique os logs do job de testes.</p>
          HTML
          [ -f logs/log.html ] || cat > logs/log.html <<HTML
          <!doctype html><meta charset="utf-8"><title>Robot Log ‚Äî ${BRANCH} ‚Äî ${DATE}</title>
          <h1>Robot Log ‚Äî ${BRANCH} ‚Äî ${DATE}</h1>
          <p>Nenhum log dispon√≠vel. Verifique a execu√ß√£o do job de testes.</p>
          HTML
          [ -f logs/index.html ] || cat > logs/index.html <<HTML
          <!doctype html><meta charset="utf-8">
          <title>Robot Logs ‚Äî ${BRANCH} ‚Äî ${DATE}</title>
          <h1>Robot Logs ‚Äî ${BRANCH} ‚Äî ${DATE}</h1>
          <p>Redirecionando para <a href="report.html">report.html</a>‚Ä¶</p>
          <meta http-equiv="refresh" content="0; url=report.html">
          HTML

      - name: üì§ Upload Robot Framework logs (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.set_meta.outputs.artifact_name }}
          path: logs/

  deploy-pages:
    if: always()
    needs: test
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: ‚¨áÔ∏è Download logs artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ needs.test.outputs.artifact_name }}
          path: logs
        continue-on-error: true

      - name: üß∑ Ensure logs exist (fallback in deploy job)
        env:
          BRANCH: ${{ needs.test.outputs.branch }}
          DATE: ${{ needs.test.outputs.date }}
        run: |
          mkdir -p logs
          [ -f logs/index.html ] || cat > logs/index.html <<HTML
          <!doctype html><meta charset="utf-8">
          <title>Robot Logs ‚Äî ${BRANCH} ‚Äî ${DATE}</title>
          <h1>Robot Logs ‚Äî ${BRANCH} ‚Äî ${DATE}</h1>
          <p>Nenhum artifact foi baixado. Verifique a execu√ß√£o do job de testes.</p>
          HTML

      - name: ‚¨ÜÔ∏è Upload Pages artifact (logs/)
        uses: actions/upload-pages-artifact@v3
        with:
          path: logs

      - name: üöÄ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

      - name: üì¢ Show logs URL (console + summary)
        env:
          LOGS_URL: ${{ steps.deployment.outputs.page_url }}
          DATE: ${{ needs.test.outputs.datetime }}
          BRANCH: ${{ needs.test.outputs.branch }}
        run: |
          echo "‚úÖ Logs publicados com sucesso!"
          echo "üìÖ Data: ${DATE}"
          echo "üåø Branch: ${BRANCH}"
          echo "üåê URL: ${LOGS_URL}"
          {
            echo "## üìä Robot Framework ‚Äî Logs/Publica√ß√£o"
            echo ""
            echo "**üìÖ Data:** ${DATE}  "
            echo "**üåø Branch:** ${BRANCH}  "
            echo ""
            echo "[üëâ Acessar Logs](${LOGS_URL})"
          } >> $GITHUB_STEP_SUMMARY
