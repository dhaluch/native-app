name: Run Robot Framework Tests

on:
  push:
    branches:
      - main
      - feature/*
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v3

      - name: ğŸ Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: ğŸ“¦ Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install robotframework
          pip install robotframework-appiumlibrary
          # Se seus testes usam Browser/Playwright, mantenha as 2 linhas abaixo:
          pip install robotframework-browser
          rfbrowser init

      - name: ğŸŸ¢ Install Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: ğŸ¤– Set up Android SDK
        uses: android-actions/setup-android@v3

      - name: ğŸ› ï¸ Configure PATH and Android folders
        run: |
          export PATH=$PATH:$ANDROID_HOME/emulator
          mkdir -p $HOME/.android
          touch $HOME/.android/emu-update-last-check.ini
          mkdir -p $HOME/.android/avd

      - name: ğŸ“² Create Android emulator
        run: |
          export ANDROID_SDK_ROOT=$ANDROID_HOME
          export ANDROID_AVD_HOME=$HOME/.android/avd
          export PATH=$PATH:$ANDROID_HOME/emulator

          echo "y" | sdkmanager --install 'system-images;android-30;google_apis;x86_64'

          echo "no" | avdmanager create avd \
            -n test \
            -k 'system-images;android-30;google_apis;x86_64' \
            --device 'pixel' --force

          $ANDROID_HOME/emulator/emulator -list-avds || echo "âš ï¸ Nenhum AVD listado!"
          ls -la "$ANDROID_AVD_HOME" || echo "âš ï¸ DiretÃ³rio AVD nÃ£o encontrado!"

      - name: ğŸš€ Start Android emulator (software mode)
        run: |
          export PATH=$PATH:$ANDROID_HOME/emulator
          nohup $ANDROID_HOME/emulator/emulator -avd test \
            -accel off \
            -gpu swiftshader_indirect \
            -no-boot-anim \
            -no-snapshot \
            -no-snapshot-save \
            -camera-back none \
            -camera-front none \
            -no-window \
            -no-audio &
          adb wait-for-device
          adb devices

      - name: â³ Wait for full boot (multi-signal, with timeouts)
        run: |
          set -e
          BOOT_TIMEOUT=360
          PM_TIMEOUT=180

          echo "â³ Esperando sys.boot_completed ou dev.bootcomplete..."
          if ! timeout ${BOOT_TIMEOUT}s bash -c 'until adb shell getprop sys.boot_completed 2>/dev/null | tr -d "\r" | grep -q "^1$"; do sleep 3; done'; then
            echo "âš ï¸ sys.boot_completed nÃ£o sinalizou; usando dev.bootcomplete..."
            timeout ${BOOT_TIMEOUT}s bash -c 'until adb shell getprop dev.bootcomplete 2>/dev/null | tr -d "\r" | grep -q "^1$"; do sleep 3; done'
          fi
          echo "âœ… Sinal de boot recebido."

          echo "â³ Checando boot animation (tolerante)..."
          timeout 120s bash -c 'until [ "$(adb shell getprop init.svc.bootanim 2>/dev/null | tr -d "\r")" = "stopped" ]; do sleep 2; done' || echo "âš ï¸ bootanim indisponÃ­vel â€” seguindo."

          echo "â³ Esperando Package Manager..."
          timeout ${PM_TIMEOUT}s bash -c 'until adb shell pm list packages >/dev/null 2>&1; do sleep 3; done'
          echo "âœ… Package Manager pronto."

      - name: ğŸ”“ Keep screen awake & dismiss keyguard (no-fail, sem input)
        run: |
          adb shell settings put global stay_on_while_plugged_in 3 || true
          adb shell wm dismiss-keyguard || true
          adb shell am start -a android.intent.action.MAIN -c android.intent.category.HOME || true

      # ğŸ”´ NOVO: garante user 0 ativo e serviÃ§o "settings" pronto (resolve "Can't find service: settings")
      - name: âœ… Ensure Android user & settings service ready
        run: |
          set -e
          # garante que o user 0 estÃ¡ rodando
          adb shell am start-user 0 || true

          # espera atÃ© o serviÃ§o "settings" responder via cmd
          SETTINGS_TIMEOUT=180
          echo "â³ Aguardando serviÃ§o 'settings' ficar disponÃ­vel..."
          if ! timeout ${SETTINGS_TIMEOUT}s bash -c 'until adb shell cmd settings list global >/dev/null 2>&1; do sleep 3; done'; then
            echo "âŒ ServiÃ§o 'settings' nÃ£o respondeu dentro do timeout."
            # dump rÃ¡pido para diagnÃ³stico
            adb shell service list | tail -n +1 || true
            exit 1
          fi
          echo "âœ… ServiÃ§o 'settings' disponÃ­vel."

      - name: ğŸ“¦ Install Appium (CLI + driver)
        run: |
          npm install -g appium
          appium -v
          appium driver install uiautomator2@4.0.1

      - name: ğŸƒ Start Appium server
        run: |
          nohup appium &

      - name: ğŸ§ª Run Robot Framework tests with report
        run: |
          mkdir -p reports
          robot --outputdir reports tests/

      - name: ğŸ§· Create index.html (redirect to report)
        if: always()
        run: |
          test -d reports || mkdir -p reports
          cat > reports/index.html <<'EOF'
          <!doctype html><meta charset="utf-8">
          <meta http-equiv="refresh" content="0; url=report.html">
          <title>Robot Reports</title>
          <p>Redirecionando para <a href="report.html">report.html</a>â€¦</p>
          EOF

      - name: ğŸ“¤ Upload Robot Framework report (artifact)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: robot-report
          path: reports/

  deploy-pages:
    if: always()
    needs: test
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: â¬†ï¸ Upload Pages artifact (reports/)
        uses: actions/upload-pages-artifact@v3
        with:
          path: reports

      - name: ğŸš€ Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
